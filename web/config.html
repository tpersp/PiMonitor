<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PiMonitor Configuration</title>
  <style>
    :root { color-scheme: dark; }
    body {
      font-family: system-ui, sans-serif;
      background: #111;
      color: #eee;
      margin: 0;
      padding: 2rem;
    }
    h1 {
      margin-top: 0;
      font-size: 1.5rem;
    }
    form {
      margin-bottom: 2rem;
      max-width: 600px;
    }
    label {
      display: block;
      margin: 0.5rem 0;
    }
    input, select {
      width: 100%;
      padding: 0.4rem;
      margin-top: 0.2rem;
      border-radius: 4px;
      border: 1px solid #444;
      background: #222;
      color: #eee;
    }
    button {
      margin-top: 1rem;
      padding: 0.5rem 1rem;
      border: none;
      background: #2a7ae2;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background: #1f64b2;
    }
    .message {
      margin-top: 1rem;
      font-size: 0.9rem;
      opacity: 0.8;
    }
    .message.success {
      color: #8ddda0;
    }
    .message.error {
      color: #ff8a8a;
    }
    .message.info {
      color: #9cc7ff;
    }
    .wifi-networks {
      margin-top: 1rem;
    }
    .wifi-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
      font-size: 0.9rem;
    }
    .wifi-table th,
    .wifi-table td {
      border: 1px solid #333;
      padding: 0.4rem;
      text-align: left;
    }
    .wifi-table tr.current {
      background: rgba(42, 122, 226, 0.18);
    }
    .wifi-table .tag {
      display: inline-block;
      background: #2a7ae2;
      color: #fff;
      padding: 0 0.35rem;
      border-radius: 3px;
      font-size: 0.7rem;
      margin-left: 0.4rem;
    }
    a { color: #9cf; }
  </style>
</head>
<body>
  <h1>PiMonitor Configuration</h1>
  <p><a href="/">&larr; Back to live view</a></p>

  <form id="configForm">
    <label>
      Resolution
      <input type="text" name="RESOLUTION" placeholder="e.g. 1280x720" required />
    </label>
    <label>
      Frames per second (FPS)
      <input type="number" name="FPS" min="1" max="60" step="1" required />
    </label>
    <label>
      Stream mode
      <select name="STREAM_MODE">
        <option value="MJPEG">MJPEG (HTTP)</option>
        <option value="H264_RTSP">H.264 RTSP</option>
      </select>
    </label>
    <label>
      Device path
      <input type="text" name="DEVICE" list="devices" required />
      <datalist id="devices"></datalist>
    </label>
    <label>
      MJPEG port (HTTP)
      <input type="number" name="HTTP_PORT" min="1" max="65535" />
    </label>
    <label>
      H.264 RTSP port
      <input type="number" name="RTSP_PORT" min="1" max="65535" />
    </label>
    <label>
      Site port
      <input type="number" name="SITE_PORT" min="1" max="65535" />
    </label>
    <label>
      Enable authentication
      <input type="checkbox" name="ENABLE_AUTH" />
    </label>
    <label>
      Username
      <input type="text" name="AUTH_USERNAME" />
    </label>
    <label>
      Password
      <input type="password" name="AUTH_PASSWORD" />
    </label>
    <button type="submit">Save configuration</button>
  </form>

  <h2>Record video</h2>
  <form id="recordForm">
    <label>
      Duration (seconds)
      <input type="number" name="duration" min="1" value="10" />
    </label>
    <label>
      Filename
      <input type="text" name="filename" value="record.mp4" />
    </label>
    <button type="submit">Start recording</button>
  </form>

  <h2>Snapshot</h2>
  <form id="snapshotForm">
    <label>
      Filename
      <input type="text" name="filename" value="snapshot.jpg" />
    </label>
    <button type="submit">Take snapshot</button>
  </form>

  <h2>Add Wi-Fi Network</h2>
  <form id="wifiForm">
    <label>
      SSID
      <input type="text" name="ssid" required />
    </label>
    <label>
      Password (leave blank for open network)
      <input type="password" name="psk" />
    </label>
    <label>
      <input type="checkbox" name="hidden" />
      Hidden network (broadcast disabled)
    </label>
    <button type="submit">Add Wi-Fi network</button>
  </form>

  <div id="wifiNetworks" class="wifi-networks"></div>

  <div class="message" id="message"></div>

  <script>
  function escapeHtml(value) {
    if (value === undefined || value === null) {
      return '';
    }
    var div = document.createElement('div');
    div.textContent = String(value);
    return div.innerHTML;
  }

  function handleJson(res) {
    return res.json().catch(function() { return {}; }).then(function(data) {
      return { ok: res.ok, status: res.status, data: data };
    });
  }

  function loadWifiNetworks() {
    var container = document.getElementById('wifiNetworks');
    if (!container) {
      return;
    }
    container.innerHTML = '<p>Loading saved networks...</p>';
    fetch('/api/wifi')
      .then(handleJson)
      .then(function(result) {
        if (!result.ok || !result.data || result.data.status !== 'ok') {
          var msg = (result.data && result.data.error) ? result.data.error : 'Unable to load saved Wi-Fi networks.';
          container.innerHTML = '<p class="message error">' + escapeHtml(msg) + '</p>';
          return;
        }
        var networks = result.data.networks || [];
        if (!networks.length) {
          container.innerHTML = '<p>No saved networks found.</p>';
          return;
        }
        var rows = networks.map(function(net) {
          var ssid = escapeHtml(net.ssid || '(unknown)');
          var security = escapeHtml(net.security || 'unknown');
          var hidden = net.hidden ? 'Yes' : 'No';
          var statusParts = [];
          if (net.is_current) {
            statusParts.push('Connected');
          }
          if (String(net.disabled) === '1') {
            statusParts.push('Disabled');
          }
          if (net.priority !== undefined && net.priority !== null && net.priority !== '') {
            statusParts.push('Priority ' + net.priority);
          }
          var statusText = escapeHtml(statusParts.join(' | ') || 'Saved');
          var tag = net.is_current ? '<span class="tag">current</span>' : '';
          var rowClass = net.is_current ? ' class="current"' : '';
          return '<tr' + rowClass + '><td>' + ssid + tag + '</td><td>' + security + '</td><td>' + hidden + '</td><td>' + statusText + '</td></tr>';
        }).join('');
        container.innerHTML = '<table class="wifi-table"><thead><tr><th>SSID</th><th>Security</th><th>Hidden</th><th>Status</th></tr></thead><tbody>' + rows + '</tbody></table>';
      })
      .catch(function(err) {
        var message = err && err.message ? err.message : 'Failed to load saved Wi-Fi networks.';
        container.innerHTML = '<p class="message error">' + escapeHtml(message) + '</p>';
      });
  }

  // Populate device list datalist
  function loadDevices() {
    fetch('/api/devices')
      .then(function(res) { return res.json(); })
      .then(function(data) {
        var list = document.getElementById('devices');
        list.innerHTML = '';
        data.devices.forEach(function(dev) {
          var opt = document.createElement('option');
          opt.value = dev;
          list.appendChild(opt);
        });
      });
  }

  // Load current configuration into the form
  function loadConfig() {
    fetch('/api/config')
      .then(function(res) { return res.json(); })
      .then(function(cfg) {
        var form = document.getElementById('configForm');
        form.RESOLUTION.value = cfg.RESOLUTION || '';
        form.FPS.value = cfg.FPS || '';
        form.STREAM_MODE.value = cfg.STREAM_MODE || 'MJPEG';
        form.DEVICE.value = cfg.DEVICE || '';
        form.HTTP_PORT.value = cfg.HTTP_PORT || '';
        form.RTSP_PORT.value = cfg.RTSP_PORT || '';
        form.SITE_PORT.value = cfg.SITE_PORT || '';
        form.ENABLE_AUTH.checked = cfg.ENABLE_AUTH === '1';
        form.AUTH_USERNAME.value = cfg.AUTH_USERNAME || '';
        form.AUTH_PASSWORD.value = cfg.AUTH_PASSWORD || '';
      });
  }

  document.addEventListener('DOMContentLoaded', function() {
    loadDevices();
    loadConfig();
    loadWifiNetworks();
    var message = document.getElementById('message');
    var messageTimer = null;

    function showMessage(text, type) {
      if (!message) {
        return;
      }
      if (messageTimer) {
        clearTimeout(messageTimer);
        messageTimer = null;
      }
      var classes = ['message'];
      if (type) {
        classes.push(type);
      }
      message.className = classes.join(' ');
      message.textContent = text || '';
      if (text) {
        messageTimer = setTimeout(function() {
          message.textContent = '';
          message.className = 'message';
          messageTimer = null;
        }, 5000);
      }
    }

    var configForm = document.getElementById('configForm');
    if (configForm) {
      configForm.addEventListener('submit', function(e) {
        e.preventDefault();
        var form = e.target;
        var data = {
          RESOLUTION: form.RESOLUTION.value,
          FPS: form.FPS.value,
          STREAM_MODE: form.STREAM_MODE.value,
          DEVICE: form.DEVICE.value,
          HTTP_PORT: form.HTTP_PORT.value,
          RTSP_PORT: form.RTSP_PORT.value,
          SITE_PORT: form.SITE_PORT.value,
          ENABLE_AUTH: form.ENABLE_AUTH.checked ? '1' : '0',
          AUTH_USERNAME: form.AUTH_USERNAME.value,
          AUTH_PASSWORD: form.AUTH_PASSWORD.value
        };
        fetch('/api/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        })
          .then(handleJson)
          .then(function(result) {
            var resp = result.data || {};
            if (!result.ok || resp.status !== 'ok') {
              var err = resp.error || 'unknown error';
              showMessage('Failed to save configuration: ' + err, 'error');
              return;
            }
            showMessage('Configuration saved. Restarting stream...', 'success');
            loadConfig();
          })
          .catch(function(err) {
            var messageText = err && err.message ? err.message : String(err);
            showMessage('Failed to save configuration: ' + messageText, 'error');
          });
      });
    }

    var recordForm = document.getElementById('recordForm');
    if (recordForm) {
      recordForm.addEventListener('submit', function(e) {
        e.preventDefault();
        var fd = new FormData(e.target);
        var data = {
          duration: fd.get('duration'),
          filename: fd.get('filename')
        };
        fetch('/api/record', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        })
          .then(handleJson)
          .then(function(result) {
            var resp = result.data || {};
            if (!result.ok || resp.status !== 'ok') {
              var err = resp.error || 'unknown error';
              showMessage('Recording failed: ' + err, 'error');
              return;
            }
            showMessage('Recording saved to ' + (resp.file || 'file'), 'success');
          })
          .catch(function(err) {
            var messageText = err && err.message ? err.message : String(err);
            showMessage('Recording failed: ' + messageText, 'error');
          });
      });
    }

    var snapshotForm = document.getElementById('snapshotForm');
    if (snapshotForm) {
      snapshotForm.addEventListener('submit', function(e) {
        e.preventDefault();
        var fd = new FormData(e.target);
        var data = {
          filename: fd.get('filename')
        };
        fetch('/api/snapshot', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        })
          .then(handleJson)
          .then(function(result) {
            var resp = result.data || {};
            if (!result.ok || resp.status !== 'ok') {
              var err = resp.error || 'unknown error';
              showMessage('Snapshot failed: ' + err, 'error');
              return;
            }
            showMessage('Snapshot saved to ' + (resp.file || 'file'), 'success');
          })
          .catch(function(err) {
            var messageText = err && err.message ? err.message : String(err);
            showMessage('Snapshot failed: ' + messageText, 'error');
          });
      });
    }

    var wifiForm = document.getElementById('wifiForm');
    if (wifiForm) {
      wifiForm.addEventListener('submit', function(e) {
        e.preventDefault();
        var form = e.target;
        var payload = {
          ssid: form.ssid.value.trim(),
          psk: form.psk.value,
          hidden: form.hidden.checked
        };
        fetch('/api/wifi', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        })
          .then(handleJson)
          .then(function(result) {
            var resp = result.data || {};
            if (!result.ok) {
              var httpError = resp.error || ('HTTP ' + result.status);
              showMessage('Failed to add Wi-Fi network: ' + httpError, 'error');
              return;
            }
            if (resp.status === 'ok') {
              var label = resp.ssid || payload.ssid || '(unknown)';
              var note = 'Added Wi-Fi network "' + label + '"';
              if (resp.reconfigured) {
                note += ' and reloaded Wi-Fi.';
              } else {
                note += '. Reload Wi-Fi manually to activate it.';
              }
              showMessage(note, 'success');
              wifiForm.reset();
              loadWifiNetworks();
              return;
            }
            if (resp.status === 'exists') {
              var existing = resp.ssid || payload.ssid || '(unknown)';
              showMessage('Wi-Fi network "' + existing + '" already exists.', 'info');
              loadWifiNetworks();
              return;
            }
            var errorText = resp.error || 'unknown error';
            showMessage('Failed to add Wi-Fi network: ' + errorText, 'error');
          })
          .catch(function(err) {
            var messageText = err && err.message ? err.message : String(err);
            showMessage('Failed to add Wi-Fi network: ' + messageText, 'error');
          });
      });
    }
  });
  </script>
</body>
</html>

